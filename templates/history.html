{% extends "base.html" %}

{% block title %}Learning History{% endblock %}

{% block content %}
<div class="history-page">
    <div class="container">
        <!-- Header -->
        <header class="history-header">
            <h1 class="history-title">Learning History</h1>
            <p class="history-subtitle">Track your learning journey and progress over time</p>
        </header>

        <!-- Stats Grid -->
        <div id="stats-container" class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-sessions">-</div>
                <div class="stat-label">Total Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completed-quizzes">-</div>
                <div class="stat-label">Quizzes Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="average-score">-</div>
                <div class="stat-label">Average Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="unique-topics">-</div>
                <div class="stat-label">Topics Explored</div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="history-loading" class="loading-overlay">
            <div class="spinner spinner-lg"></div>
            <p class="loading-text">Loading your history...</p>
        </div>

        <!-- Empty State (hidden initially) -->
        <div id="history-empty" class="empty-state hidden">
            <div class="empty-icon">ðŸ“š</div>
            <h2 class="empty-title">No learning sessions yet</h2>
            <p class="empty-description">Start your first lesson to begin tracking your progress.</p>
            <a href="/" class="btn btn-primary btn-lg">
                <i data-lucide="play" style="width: 18px; height: 18px;"></i>
                <span>Start Learning</span>
            </a>
        </div>

        <!-- History List (hidden initially) -->
        <div id="history-list" class="history-list hidden">
            <!-- Items will be generated dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadHistory() {
    const loadingEl = document.getElementById('history-loading');
    const emptyEl = document.getElementById('history-empty');
    const listEl = document.getElementById('history-list');

    try {
        const response = await fetch('/api/history');
        const data = await response.json();

        // Hide loading
        loadingEl.classList.add('hidden');

        // Update stats
        const stats = data.stats;
        document.getElementById('total-sessions').textContent = stats.total_sessions;
        document.getElementById('completed-quizzes').textContent = stats.completed_sessions;
        document.getElementById('average-score').textContent = stats.average_score + '%';
        document.getElementById('unique-topics').textContent = stats.unique_topics;

        const sessions = data.sessions;

        if (sessions.length === 0) {
            emptyEl.classList.remove('hidden');
            lucide.createIcons();
            return;
        }

        // Populate list
        listEl.classList.remove('hidden');

        sessions.forEach(session => {
            const item = document.createElement('div');
            item.className = 'history-item animate-fade-in';

            const date = new Date(session.created_at);
            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            let badgeClass = 'incomplete';
            let badgeText = 'In Progress';

            if (session.completed_at) {
                const pct = session.percentage || 0;
                if (pct >= 80) {
                    badgeClass = 'excellent';
                } else if (pct >= 60) {
                    badgeClass = 'good';
                } else {
                    badgeClass = 'needs-work';
                }
                badgeText = `${Math.round(pct)}%`;
            }

            item.innerHTML = `
                <div class="history-info">
                    <div class="history-icon">
                        <i data-lucide="book-open" style="width: 20px; height: 20px;"></i>
                    </div>
                    <div class="history-details">
                        <h3>${session.topic}</h3>
                        <p>${formattedDate} â€¢ ${session.difficulty}</p>
                    </div>
                </div>
                <div class="history-score">
                    ${session.completed_at ? `<span>${session.score}/${session.total_questions}</span>` : ''}
                    <span class="score-badge ${badgeClass}">${badgeText}</span>
                </div>
            `;

            listEl.appendChild(item);
        });

        // Initialize icons
        lucide.createIcons();
    } catch (error) {
        console.error('Error loading history:', error);
        loadingEl.innerHTML = `
            <div style="text-align: center;">
                <p style="color: var(--color-text-tertiary);">Error loading history. Please try again.</p>
                <button onclick="loadHistory()" class="btn btn-secondary mt-4">Retry</button>
            </div>
        `;
    }
}

loadHistory();
</script>
{% endblock %}
