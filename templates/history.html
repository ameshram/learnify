{% extends "base.html" %}

{% block title %}Learning History{% endblock %}

{% block content %}
<div class="history-page">
    <div class="container">
        <header class="history-header">
            <h1>Learning History</h1>
            <p>Track your learning journey</p>
        </header>

        <div id="stats-container" class="stats-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-sessions">-</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-quizzes">-</div>
                    <div class="stat-label">Quizzes Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="average-score">-</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unique-topics">-</div>
                    <div class="stat-label">Topics Explored</div>
                </div>
            </div>
        </div>

        <div id="history-loading" class="history-loading">
            <div class="loading-spinner"></div>
            <p>Loading history...</p>
        </div>

        <div id="history-empty" class="history-empty" style="display:none;">
            <div class="empty-state">
                <div class="empty-icon">ðŸ“š</div>
                <h2>No learning sessions yet</h2>
                <p>Start your first lesson to begin tracking your progress.</p>
                <a href="/" class="btn btn-primary">Start Learning</a>
            </div>
        </div>

        <div id="history-list" class="history-list" style="display:none;">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadHistory() {
    try {
        const response = await fetch('/api/history');
        const data = await response.json();

        document.getElementById('history-loading').style.display = 'none';

        // Update stats
        const stats = data.stats;
        document.getElementById('total-sessions').textContent = stats.total_sessions;
        document.getElementById('completed-quizzes').textContent = stats.completed_sessions;
        document.getElementById('average-score').textContent = stats.average_score + '%';
        document.getElementById('unique-topics').textContent = stats.unique_topics;

        const sessions = data.sessions;
        if (sessions.length === 0) {
            document.getElementById('history-empty').style.display = 'block';
            return;
        }

        const historyList = document.getElementById('history-list');
        historyList.style.display = 'block';

        sessions.forEach(session => {
            const card = document.createElement('div');
            card.className = 'history-card';

            const date = new Date(session.created_at);
            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            let statusClass = 'status-incomplete';
            let statusText = 'In Progress';
            let scoreHtml = '';

            if (session.completed_at) {
                const pct = session.percentage || 0;
                if (pct >= 80) statusClass = 'status-excellent';
                else if (pct >= 60) statusClass = 'status-good';
                else statusClass = 'status-needs-work';

                statusText = `${session.score}/${session.total_questions} (${Math.round(pct)}%)`;
                scoreHtml = `<div class="history-score ${statusClass}">${statusText}</div>`;
            } else {
                scoreHtml = `<div class="history-score ${statusClass}">${statusText}</div>`;
            }

            card.innerHTML = `
                <div class="history-card-header">
                    <h3 class="history-topic">${session.topic}</h3>
                    <span class="history-difficulty">${session.difficulty}</span>
                </div>
                <div class="history-card-body">
                    <div class="history-date">${formattedDate}</div>
                    ${scoreHtml}
                </div>
            `;

            historyList.appendChild(card);
        });
    } catch (error) {
        console.error('Error loading history:', error);
        document.getElementById('history-loading').innerHTML =
            '<p>Error loading history. Please try again.</p>';
    }
}

loadHistory();
</script>
{% endblock %}
